name: CI/CD Pipeline - Casa Inteligente

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPOSITORY: casa-inteligente
  SERVICE_NAME: casa-inteligente
  API_SERVICE_URL: https://casa-inteligente-858582953113.us-central1.run.app
  API_SERVICE_TARGET: casa-inteligente-858582953113.us-central1.run.app:443
  STREAMLIT_SERVICE_NAME: casa-inteligente-dashboard
  PROMETHEUS_SERVICE_NAME: casa-inteligente-prometheus
  GRAFANA_SERVICE_NAME: casa-inteligente-grafana

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: casa_inteligente_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run linting
      run: |
        pip install flake8 black
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        black --check src/

    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/casa_inteligente_test
        REDIS_URL: redis://localhost:6379
        TESTING: true
      run: |
        pytest tests/ -v || echo "Tests failed but continuing..."
      continue-on-error: true

  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      continue-on-error: true
      run: |
        pip install safety bandit
        safety scan --continue-on-error || true
        bandit -r src/ -ll || true

  build:
    needs: [security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t $REGISTRY/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:$GITHUB_SHA \
                     -t $REGISTRY/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:latest .

    - name: Push Docker image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy $SERVICE_NAME \
          --image $REGISTRY/$PROJECT_ID/$REPOSITORY/$SERVICE_NAME:$GITHUB_SHA \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 10 \
          --min-instances 0 \
          --set-env-vars SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
          --set-env-vars SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
          --set-env-vars REDIS_URL=${{ secrets.REDIS_URL }} \
          --set-env-vars TAPO_USERNAME=${{ secrets.TAPO_USERNAME }} \
          --set-env-vars TAPO_PASSWORD=${{ secrets.TAPO_PASSWORD }} \
          --set-env-vars TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
          --set-env-vars TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
          --set-env-vars EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }} \
          --set-env-vars EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }} \
          --set-env-vars OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
          --set-env-vars GOOGLE_AI_API_KEY=${{ secrets.GOOGLE_AI_API_KEY }} \
          --set-env-vars ENABLE_COLLECTOR=false \
          --set-env-vars COLLECTOR_INIT_TIMEOUT_SECONDS=5 \
          --set-env-vars COLLECTION_INTERVAL_MINUTES=15

  build_streamlit:
    needs: [security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Streamlit image
      run: |
        docker build -f docker/streamlit/Dockerfile \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/streamlit:$GITHUB_SHA \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/streamlit:latest .

    - name: Push Streamlit image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/streamlit:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/streamlit:latest

  deploy_streamlit:
    needs: [build_streamlit]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy Streamlit to Cloud Run
      run: |
        gcloud run deploy $STREAMLIT_SERVICE_NAME \
          --image $REGISTRY/$PROJECT_ID/$REPOSITORY/streamlit:$GITHUB_SHA \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --port 8501 \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 5 \
          --set-env-vars API_BASE_URL=${{ env.API_SERVICE_URL }}

  build_prometheus:
    needs: [security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Prometheus image
      run: |
        docker build -f docker/prometheus/Dockerfile \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/prometheus:$GITHUB_SHA \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/prometheus:latest .

    - name: Push Prometheus image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/prometheus:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/prometheus:latest

  deploy_prometheus:
    needs: [build_prometheus]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      prometheus_url: ${{ steps.prom_url.outputs.url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy Prometheus to Cloud Run
      run: |
        gcloud run deploy $PROMETHEUS_SERVICE_NAME \
          --image $REGISTRY/$PROJECT_ID/$REPOSITORY/prometheus:$GITHUB_SHA \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --port 9090 \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 3 \
          --set-env-vars API_TARGET=${{ env.API_SERVICE_TARGET }}

    - name: Capture Prometheus URL
      id: prom_url
      run: |
        URL=$(gcloud run services describe $PROMETHEUS_SERVICE_NAME --region us-central1 --format='value(status.url)')
        echo "Prometheus URL: ${URL}"
        echo "url=${URL}" >> "$GITHUB_OUTPUT"

  build_grafana:
    needs: [security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Grafana image
      run: |
        docker build -f docker/grafana/Dockerfile \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/grafana:$GITHUB_SHA \
          -t $REGISTRY/$PROJECT_ID/$REPOSITORY/grafana:latest .

    - name: Push Grafana image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/grafana:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/$REPOSITORY/grafana:latest

  deploy_grafana:
    needs: [build_grafana, deploy_prometheus]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure gcloud project
      run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy Grafana to Cloud Run
      env:
        PROM_URL: ${{ needs.deploy_prometheus.outputs.prometheus_url }}
        GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
      run: |
        PASS=${GRAFANA_ADMIN_PASSWORD:-admin}
        gcloud run deploy $GRAFANA_SERVICE_NAME \
          --image $REGISTRY/$PROJECT_ID/$REPOSITORY/grafana:$GITHUB_SHA \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --port 3000 \
          --memory 1Gi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 3 \
          --set-env-vars PROMETHEUS_URL=${PROM_URL},GF_SECURITY_ADMIN_USER=admin,GF_SECURITY_ADMIN_PASSWORD=${PASS}

    - name: Create GitHub Release
      if: success()
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ðŸš€ **Deploy AutomÃ¡tico para ProduÃ§Ã£o**
          
          **Commit:** ${{ github.sha }}
          **Imagem:** ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          
          **MudanÃ§as:** ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false

    - name: Notify deployment
      if: always()
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=ðŸš€ Deploy Casa Inteligente v${{ github.run_number }}: ${{ job.status }} - Commit: ${{ github.sha }}"
